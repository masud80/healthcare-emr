rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAdmin() {
      return request.auth.token.admin == true || 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isFacilityAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'facility_admin';
    }

    function isUserConnectedToFacility(facilityId) {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return facilityId in userData.facilityIds;
    }

    function isFacilityAdminOf(facilityId) {
      let facilityData = get(/databases/$(database)/documents/facilities/$(facilityId)).data;
      return request.auth.uid in facilityData.adminIds;
    }

    // Facilities collection rules
    match /facilities/{facilityId} {
      // Read rules
      allow read: if request.auth != null && (
        isAdmin() || 
        isFacilityAdmin() || 
        isUserConnectedToFacility(facilityId)
      );

      // Create rules
      allow create: if request.auth != null && (
        isAdmin() || 
        (isFacilityAdmin() && request.resource.data.adminIds.hasAll([request.auth.uid]))
      );

      // Update rules
      allow update: if request.auth != null && (
        isAdmin() || 
        (isFacilityAdmin() && isFacilityAdminOf(facilityId))
      ) && (
        // Ensure adminIds field can't be modified by facility admins
        !isFacilityAdmin() || 
        (request.resource.data.adminIds == resource.data.adminIds)
      );

      // Delete rules - We'll use deactivation instead of deletion
      allow delete: if false;
    }

    // Prescriptions collection rules
    match /prescriptions/{prescriptionId} {
      function isDoctor() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor';
      }

      function isNurse() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'nurse';
      }

      function canPrescribe() {
        return isDoctor() || isNurse();
      }

      // Allow read if authenticated and connected to the patient's facility
      allow read: if request.auth != null && (
        isAdmin() ||
        isFacilityAdmin() ||
        isUserConnectedToFacility(resource.data.facilityId)
      );

      // Allow create if authenticated and is a doctor or nurse
      allow create: if request.auth != null && canPrescribe();

      // Allow update if authenticated and is a doctor or nurse
      allow update: if request.auth != null && canPrescribe();

      // No direct deletion allowed
      allow delete: if false;
    }

    // Pharmacy collection rules
    match /pharmacies/{pharmacyId} {
      // Allow read if authenticated and is admin or facility admin
      allow read: if request.auth != null && (
        isAdmin() ||
        isFacilityAdmin()
      );

      // Allow create/update if authenticated and is admin or facility admin
      allow create, update: if request.auth != null && (
        isAdmin() ||
        isFacilityAdmin()
      );

      // No direct deletion allowed
      allow delete: if false;
    }

    // Default rule for other collections
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
